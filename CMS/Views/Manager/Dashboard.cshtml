<!-- Views/Manager/Index.cshtml -->
@{
    ViewData["Title"] = "Manager Dashboard";
    Layout = "_ManagerLayout";
}

<!-- Welcome Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h2>Welcome back, John! 👋</h2>
                        <p class="mb-0">Here's what's happening with your team today.</p>
                        <div class="mt-3">
                            <span class="badge bg-white text-success me-2">
                                <i class="bi bi-calendar"></i> @DateTime.Now.ToString("dddd, MMMM dd")
                            </span>
                            <span class="badge bg-white text-success">
                                <i class="bi bi-clock"></i> <span id="liveClock"></span>
                            </span>
                        </div>
                    </div>
                    <div class="col-md-4 text-end">
                        <img src="/images/manager-welcome.svg" alt="Welcome" style="max-height: 100px;">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Team Overview Stats -->
<div class="row">
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="stat-card">
            <div class="d-flex align-items-center">
                <div class="stat-icon bg-success bg-opacity-10 text-success me-3">
                    <i class="bi bi-people"></i>
                </div>
                <div>
                    <p class="text-muted mb-1">Team Members</p>
                    <h3 class="mb-0">12</h3>
                    <small class="text-success">+2 this month</small>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="stat-card">
            <div class="d-flex align-items-center">
                <div class="stat-icon bg-info bg-opacity-10 text-info me-3">
                    <i class="bi bi-check2-circle"></i>
                </div>
                <div>
                    <p class="text-muted mb-1">Active Tasks</p>
                    <h3 class="mb-0">24</h3>
                    <small class="text-success">85% completion rate</small>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="stat-card">
            <div class="d-flex align-items-center">
                <div class="stat-icon bg-warning bg-opacity-10 text-warning me-3">
                    <i class="bi bi-file-text"></i>
                </div>
                <div>
                    <p class="text-muted mb-1">Pending Reports</p>
                    <h3 class="mb-0">5</h3>
                    <small class="text-warning">2 overdue</small>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="stat-card">
            <div class="d-flex align-items-center">
                <div class="stat-icon bg-primary bg-opacity-10 text-primary me-3">
                    <i class="bi bi-graph-up"></i>
                </div>
                <div>
                    <p class="text-muted mb-1">Team Performance</p>
                    <h3 class="mb-0">92%</h3>
                    <small class="text-success">+5% vs last month</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Team Performance Chart and Quick Actions -->
<div class="row mb-4">
    <div class="col-xl-8">
        <div class="card">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold">Team Performance Overview</h6>
                <div>
                    <select class="form-select form-select-sm" style="width: auto;" id="performancePeriod">
                        <option value="week">This Week</option>
                        <option value="month" selected>This Month</option>
                        <option value="quarter">This Quarter</option>
                    </select>
                </div>
            </div>
            <div class="card-body">
                <canvas id="teamPerformanceChart" height="250"></canvas>
            </div>
        </div>
    </div>

    <div class="col-xl-4">
        <div class="card">
            <div class="card-header bg-white">
                <h6 class="m-0 font-weight-bold">Quick Actions</h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-success text-start" onclick="quickAssignTask()">
                        <i class="bi bi-plus-circle me-2"></i> Assign New Task
                    </button>
                    <button class="btn btn-outline-primary text-start" onclick="quickScheduleMeeting()">
                        <i class="bi bi-calendar-plus me-2"></i> Schedule Team Meeting
                    </button>
                    <button class="btn btn-outline-warning text-start" onclick="quickRequestReport()">
                        <i class="bi bi-file-text me-2"></i> Request Report
                    </button>
                    <button class="btn btn-outline-info text-start" onclick="quickSendAnnouncement()">
                        <i class="bi bi-megaphone me-2"></i> Team Announcement
                    </button>
                    <button class="btn btn-outline-secondary text-start" onclick="quickGiveFeedback()">
                        <i class="bi bi-chat me-2"></i> Give Feedback
                    </button>
                </div>

                <hr>

                <h6 class="font-weight-bold mb-3">Today's Schedule</h6>
                <div class="schedule-item mb-3">
                    <div class="d-flex justify-content-between">
                        <span class="badge bg-primary">10:00 AM</span>
                        <small class="text-muted">30 min</small>
                    </div>
                    <p class="mb-0">Daily Standup Meeting</p>
                    <small class="text-muted">Conference Room A</small>
                </div>
                <div class="schedule-item mb-3">
                    <div class="d-flex justify-content-between">
                        <span class="badge bg-success">2:00 PM</span>
                        <small class="text-muted">1 hour</small>
                    </div>
                    <p class="mb-0">Client Presentation</p>
                    <small class="text-muted">Zoom Meeting</small>
                </div>
                <div class="schedule-item">
                    <div class="d-flex justify-content-between">
                        <span class="badge bg-warning">4:30 PM</span>
                        <small class="text-muted">15 min</small>
                    </div>
                    <p class="mb-0">1-on-1 with Sarah</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Team Members Online -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold">Team Members Online</h6>
                <a href="@Url.Action("Index", "ManagerTeam")" class="btn btn-sm btn-outline-primary">
                    View All Team
                </a>
            </div>
            <div class="card-body">
                <div class="row" id="onlineTeamMembers">
                    <!-- Team members will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Activities and Pending Tasks -->
<div class="row">
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold">Recent Team Activities</h6>
                <a href="@Url.Action("TeamActivity", "Manager")" class="btn btn-sm btn-link">View All</a>
            </div>
            <div class="card-body">
                <div class="timeline" id="recentActivities">
                    <!-- Activities will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold">Priority Tasks</h6>
                <a href="@Url.Action("Index", "ManagerTask")" class="btn btn-sm btn-link">View All Tasks</a>
            </div>
            <div class="card-body">
                <div id="priorityTasks">
                    <!-- Tasks will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Team Performance Metrics -->
<div class="row">
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header bg-white">
                <h6 class="m-0 font-weight-bold">Task Distribution</h6>
            </div>
            <div class="card-body">
                <canvas id="taskDistributionChart" height="200"></canvas>
            </div>
        </div>
    </div>

    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header bg-white">
                <h6 class="m-0 font-weight-bold">Team Workload</h6>
            </div>
            <div class="card-body">
                <div id="teamWorkload">
                    <!-- Workload bars will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Assign Task Modal -->
<div class="modal fade" id="assignTaskModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Assign New Task</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="assignTaskForm">
                    <div class="mb-3">
                        <label class="form-label">Task Title</label>
                        <input type="text" class="form-control" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" name="description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Assign To</label>
                        <select class="form-select" name="assignedTo" required>
                            <option value="">Select Team Member</option>
                            <option value="1">Sarah Johnson</option>
                            <option value="2">Mike Chen</option>
                            <option value="3">Emily Brown</option>
                            <option value="4">David Wilson</option>
                        </select>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Priority</label>
                            <select class="form-select" name="priority">
                                <option value="Low">Low</option>
                                <option value="Medium">Medium</option>
                                <option value="High">High</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Due Date</label>
                            <input type="date" class="form-control" name="dueDate">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="saveTask()">Assign Task</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let performanceChart, distributionChart;

        $(document).ready(function() {
            initializeCharts();
            loadTeamMembers();
            loadRecentActivities();
            loadPriorityTasks();
            loadTeamWorkload();
            updateLiveClock();

            // Update clock every second
            setInterval(updateLiveClock, 1000);

            // Period change handler
            $('#performancePeriod').change(function() {
                updatePerformanceChart($(this).val());
            });
        });

        function updateLiveClock() {
            $('#liveClock').text(moment().format('h:mm:ss A'));
        }

        function initializeCharts() {
            // Team Performance Chart
            const perfCtx = document.getElementById('teamPerformanceChart').getContext('2d');
            performanceChart = new Chart(perfCtx, {
                type: 'line',
                data: {
                    labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                    datasets: [{
                        label: 'Tasks Completed',
                        data: [45, 52, 48, 58],
                        borderColor: '#1cc88a',
                        backgroundColor: 'rgba(28, 200, 138, 0.1)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'Team Productivity',
                        data: [78, 82, 80, 88],
                        borderColor: '#36b9cc',
                        backgroundColor: 'rgba(54, 185, 204, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // Task Distribution Chart
            const distCtx = document.getElementById('taskDistributionChart').getContext('2d');
            distributionChart = new Chart(distCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Completed', 'In Progress', 'Pending', 'Overdue'],
                    datasets: [{
                        data: [45, 25, 20, 10],
                        backgroundColor: ['#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    },
                    cutout: '70%'
                }
            });
        }

        function updatePerformanceChart(period) {
            // Simulate different data for different periods
            let data;
            switch(period) {
                case 'week':
                    data = [12, 15, 18, 14, 16, 20, 22];
                    break;
                case 'month':
                    data = [45, 52, 48, 58];
                    break;
                case 'quarter':
                    data = [145, 162, 158];
                    break;
            }

            performanceChart.data.datasets[0].data = data;
            performanceChart.update();
        }

        function loadTeamMembers() {
            const members = [
                { name: 'Sarah Johnson', role: 'Senior Developer', status: 'online', avatar: 'SJ', tasks: 4 },
                { name: 'Mike Chen', role: 'Developer', status: 'online', avatar: 'MC', tasks: 3 },
                { name: 'Emily Brown', role: 'UI Designer', status: 'away', avatar: 'EB', tasks: 2 },
                { name: 'David Wilson', role: 'Developer', status: 'online', avatar: 'DW', tasks: 5 },
                { name: 'Lisa Anderson', role: 'QA Engineer', status: 'busy', avatar: 'LA', tasks: 3 },
                { name: 'James Taylor', role: 'Developer', status: 'online', avatar: 'JT', tasks: 4 }
            ];

            let html = '';
            members.forEach(member => {
                html += `
                    <div class="col-md-4 col-lg-2 mb-3">
                        <div class="team-member-card card">
                            <div class="card-body text-center">
                                <div class="position-relative d-inline-block">
                                    <div class="member-avatar mx-auto">${member.avatar}</div>
                                    <span class="team-status status-${member.status} position-absolute bottom-0 end-0"></span>
                                </div>
                                <h6 class="mt-2 mb-0">${member.name}</h6>
                                <small class="text-muted">${member.role}</small>
                                <div class="mt-2">
                                    <span class="badge bg-light text-dark">${member.tasks} tasks</span>
                                </div>
                                <div class="mt-2">
                                    <button class="btn btn-sm btn-outline-success" onclick="assignTaskTo('${member.name}')">
                                        <i class="bi bi-plus"></i> Assign
                                    </button>
                                    <button class="btn btn-sm btn-outline-primary" onclick="messageMember('${member.name}')">
                                        <i class="bi bi-chat"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            $('#onlineTeamMembers').html(html);
        }

        function loadRecentActivities() {
            const activities = [
                { user: 'Sarah Johnson', action: 'completed task', task: 'UI Implementation', time: '5 min ago', type: 'success' },
                { user: 'Mike Chen', action: 'submitted report', task: 'Weekly Progress', time: '15 min ago', type: 'info' },
                { user: 'Emily Brown', action: 'updated design', task: 'Homepage mockup', time: '1 hour ago', type: 'primary' },
                { user: 'David Wilson', action: 'commented on', task: 'API documentation', time: '2 hours ago', type: 'warning' }
            ];

            let html = '';
            activities.forEach(act => {
                html += `
                    <div class="timeline-item mb-3">
                        <div class="d-flex">
                            <div class="timeline-icon bg-${act.type} bg-opacity-10 text-${act.type} me-3">
                                <i class="bi bi-person"></i>
                            </div>
                            <div class="flex-grow-1">
                                <strong>${act.user}</strong> ${act.action}
                                <span class="text-primary">${act.task}</span>
                                <br>
                                <small class="text-muted">${act.time}</small>
                            </div>
                        </div>
                    </div>
                `;
            });
            $('#recentActivities').html(html);
        }

        function loadPriorityTasks() {
            const tasks = [
                { title: 'Complete UI Implementation', assignee: 'Sarah Johnson', priority: 'High', due: 'Today', status: 'in-progress' },
                { title: 'Review API Documentation', assignee: 'Mike Chen', priority: 'Medium', due: 'Tomorrow', status: 'pending' },
                { title: 'Client Meeting Preparation', assignee: 'Emily Brown', priority: 'High', due: 'Today', status: 'in-progress' },
                { title: 'Fix Production Bug', assignee: 'David Wilson', priority: 'Critical', due: 'Today', status: 'overdue' }
            ];

            let html = '';
            tasks.forEach(task => {
                let priorityClass = task.priority === 'High' || task.priority === 'Critical' ? 'danger' :
                                   task.priority === 'Medium' ? 'warning' : 'success';
                let statusIcon = task.status === 'in-progress' ? 'arrow-repeat' :
                                task.status === 'overdue' ? 'exclamation-triangle' : 'clock';

                html += `
                    <div class="task-card priority-${task.priority.toLowerCase()} mb-3 p-3 bg-light rounded">
                        <div class="d-flex justify-content-between">
                            <h6 class="mb-1">${task.title}</h6>
                            <span class="badge bg-${priorityClass}">${task.priority}</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <small class="text-muted">
                                    <i class="bi bi-person"></i> ${task.assignee}
                                </small>
                                <br>
                                <small class="text-muted">
                                    <i class="bi bi-calendar"></i> Due: ${task.due}
                                </small>
                            </div>
                            <span class="badge bg-${task.status === 'overdue' ? 'danger' : 'info'}">
                                <i class="bi bi-${statusIcon}"></i> ${task.status}
                            </span>
                        </div>
                    </div>
                `;
            });
            $('#priorityTasks').html(html);
        }

        function loadTeamWorkload() {
            const workload = [
                { name: 'Sarah Johnson', tasks: 4, capacity: 75 },
                { name: 'Mike Chen', tasks: 3, capacity: 60 },
                { name: 'Emily Brown', tasks: 2, capacity: 40 },
                { name: 'David Wilson', tasks: 5, capacity: 90 },
                { name: 'Lisa Anderson', tasks: 3, capacity: 55 },
                { name: 'James Taylor', tasks: 4, capacity: 70 }
            ];

            let html = '';
            workload.forEach(member => {
                let barClass = member.capacity > 80 ? 'bg-danger' :
                              member.capacity > 60 ? 'bg-warning' : 'bg-success';

                html += `
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span>${member.name}</span>
                            <span>${member.tasks} tasks</span>
                        </div>
                        <div class="progress progress-sm">
                            <div class="progress-bar ${barClass}" style="width: ${member.capacity}%"></div>
                        </div>
                    </div>
                `;
            });
            $('#teamWorkload').html(html);
        }

        function assignTaskTo(memberName) {
            $('#assignTaskModal').modal('show');
            // Pre-select the team member if possible
            $(`#assignTaskForm select[name="assignedTo"] option`).each(function() {
                if ($(this).text().includes(memberName)) {
                    $(this).prop('selected', true);
                }
            });
        }

        function messageMember(memberName) {
            $('#teamChatModal').modal('show');
            // Focus on chat input
            setTimeout(() => {
                $('#teamChatModal input[type="text"]').focus();
            }, 500);
        }

        function saveTask() {
            // Implement task saving
            $('#assignTaskModal').modal('hide');
            showNotification('Task assigned successfully!', 'success');
        }

        function quickGiveFeedback() {
            alert('Feedback form would open here');
        }

        function showNotification(message, type) {
            // You can implement a toast notification here
            alert(message);
        }
    </script>
}